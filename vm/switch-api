#!/usr/bin/env bash
#
# Change API in running VM

scriptloc=$(dirname "$0")
develroot=$(dirname "${scriptloc}")
rundir="${XDG_RUNTIME_DIR}/osbuild-vm"

ssh -q localvm sudo systemctl stop '*osbuild*'

# Gen certs
mkdir -p "${rundir}/config"
"${develroot}"/vm/gen-certs.sh "${develroot}/vm/openssl.cnf" "${rundir}/config" "${rundir}/config/ca"

# Copy into VM
ssh -q root@localvm mkdir -p /etc/osbuild-composer
cp "${develroot}"/vm/config/*.toml "${rundir}"/config/.
scp -q -r "${rundir}"/config/* root@localvm:/etc/osbuild-composer/.
ssh -q root@localvm chmod ugo+rX -R /etc/osbuild-composer/

ssh -q localvm sudo systemctl start osbuild-composer-api.socket osbuild-remote-worker.socket

curl -s -k --cert "${rundir}/config/client-crt.pem" --cacert "${rundir}/config/ca-crt.pem" --key "${rundir}/config/client-key.pem" https://localhost:10443/api/composer/v1/openapi.json | jq '.paths | keys'
